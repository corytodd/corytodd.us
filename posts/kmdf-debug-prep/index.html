<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="KMDF Debugger Preparation">
<meta itemprop="description" content="Developing drivers for Windows is enjoyable but getting up and running takes some time. Today we&rsquo;ll be walking through the steps required to get a minimal debugger setup. In this post, we&rsquo;ll be preparing for a fully function kernel mode debugger configuration. That includes getting all the tools installed, VMs provisioned, and a driver deployed.
Environment  Host  Windows 10 x64 20H2 Visual Studio Community 2019 16.10.4 Windows Driver Kit Spectre Mitigated Libraries VMWare Workstation 16."><meta itemprop="datePublished" content="2021-07-24T09:58:23-07:00" />
<meta itemprop="dateModified" content="2021-07-25T10:35:30-07:00" />
<meta itemprop="wordCount" content="727"><meta itemprop="image" content="https://corytodd.us/img/coder_1.jpg"/>
<meta itemprop="keywords" content="Driver,VisualStudio," /><meta property="og:title" content="KMDF Debugger Preparation" />
<meta property="og:description" content="Developing drivers for Windows is enjoyable but getting up and running takes some time. Today we&rsquo;ll be walking through the steps required to get a minimal debugger setup. In this post, we&rsquo;ll be preparing for a fully function kernel mode debugger configuration. That includes getting all the tools installed, VMs provisioned, and a driver deployed.
Environment  Host  Windows 10 x64 20H2 Visual Studio Community 2019 16.10.4 Windows Driver Kit Spectre Mitigated Libraries VMWare Workstation 16." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://corytodd.us/posts/kmdf-debug-prep/" /><meta property="og:image" content="https://corytodd.us/img/coder_1.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-24T09:58:23-07:00" />
<meta property="article:modified_time" content="2021-07-25T10:35:30-07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://corytodd.us/img/coder_1.jpg"/>

<meta name="twitter:title" content="KMDF Debugger Preparation"/>
<meta name="twitter:description" content="Developing drivers for Windows is enjoyable but getting up and running takes some time. Today we&rsquo;ll be walking through the steps required to get a minimal debugger setup. In this post, we&rsquo;ll be preparing for a fully function kernel mode debugger configuration. That includes getting all the tools installed, VMs provisioned, and a driver deployed.
Environment  Host  Windows 10 x64 20H2 Visual Studio Community 2019 16.10.4 Windows Driver Kit Spectre Mitigated Libraries VMWare Workstation 16."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>KMDF Debugger Preparation</title>
	<link rel="stylesheet" href="https://corytodd.us/css/style.min.6b3ae8914885c12febe668e700a27cf5ff839cd06fd1ecabb5c62d91c301cc7a.css" integrity="sha256-azrokUiFwS/r5mjnAKJ89f+DnNBv0eyrtcYtkcMBzHo=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://corytodd.us">Cory Todd</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://corytodd.us/about-hugo/">About</a>
				<a href="https://corytodd.us/resume/">Experience</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://github.com/corytodd" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://corytodd.us/key.asc" target="_blank" rel="noopener me" title="Gpg"><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"> <g transform="translate(0 -142.26666)"> <g> <path d="M11.4,142.5c-4.2,0-7.6,3.4-7.6,7.6v3.7H2.5l0.1,5.9c1.3-1.7,3.3-3.2,6.6-3.4c4.6-0.3,7-1.1,8.5-1.8l0,0l0,0l0,0l0,0l0,0 l0,0l0,0l0,0l0,0c0,0,0,0,0.1,0l0,0l0,0l0,0h0l0,0l0,0l0,0l0,0l0,0h0c0,0,0,0,0.1,0h0h0l0.1,0h0l0,0l0,0l0,0l0,0l0,0l0,0l0,0l0,0 l0,0l0,0l0,0l0,0l0,0l0,0l0,0l0,0l0,0l0,0h0l0,0l0,0h0l0,0h0h0l0,0h0h0h0l0,0l0,0h0l0,0l0,0c0,0,0,0,0.1,0v-3.7 C19,145.9,15.6,142.5,11.4,142.5L11.4,142.5z M7.3,153.9v-3.7c0-2.3,1.8-4.1,4.1-4.1c2.3,0,4.1,1.8,4.1,4.1v3.7H7.3L7.3,153.9z M20.3,155.3L20.3,155.3c-2.1,2.2-5.2,4.3-9.4,4.3c0.6,0.1,1.3,0.1,1.9,0.1c2,0,3.7-0.4,4.8-1c0.9-0.5,2.2-1.3,2.5-1.3 c0.2,0,0.1,0.3-0.4,1c-1.5,2-4.2,4.2-10.9,4.2c-0.1,0-0.3,0-0.4,0c1.2,0.3,2.6,0.4,4,0.4c1.3,0,2.5-0.1,3.4-0.3 c1.1-0.3,2.1-0.9,2.4-0.9c0.2,0,0,0.2-0.5,0.8c-1.5,1.5-4.4,2.7-7.1,2.7c-0.1,0-0.2,0-0.3,0c-0.6,0-1.1,0-1.5,0 c-1.2,0-2.2,0.1-3.4,0.8h15.2V155.3L20.3,155.3z"/> </g> </g> </svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://corytodd.us/about-hugo/">About</a></li>
			<li><a href="https://corytodd.us/resume/">Experience</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta">
					<span>
						<p>
							Jul 24, 2021
							&#183;
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
							
								
							
							4 minute read
						</p>
					</span>
				</div>
				<h1>KMDF Debugger Preparation</h1>
			</header>
			<div class="content">
				<p>Developing drivers for Windows is enjoyable but getting up and running takes some time. Today we&rsquo;ll be walking through the steps required to get a minimal debugger setup. In this post, we&rsquo;ll be preparing for a fully function kernel mode debugger configuration. That includes getting all the tools installed, VMs provisioned, and a driver deployed.</p>
<h3 id="environment">Environment<a href="#environment" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ul>
<li>Host
<ul>
<li>Windows 10 x64 20H2</li>
<li>Visual Studio Community 2019 16.10.4</li>
<li>Windows Driver Kit</li>
<li>Spectre Mitigated Libraries</li>
<li>VMWare Workstation 16.0</li>
</ul>
</li>
<li>Target
<ul>
<li><a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">WinDev2106Eval.VMware.zip</a></li>
<li>Host-Only Networking</li>
</ul>
</li>
</ul>
<h2 id="host-setup-part-1">Host Setup Part 1<a href="#host-setup-part-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>After you install Visual Studio 2019, navigate to <code>Tools-&gt;Get Tools and Features</code> to install some additional components. Select the individual components tabs and search for <code>spectre latest x64</code> then check the box next to <code>MSVC vXXX - VS2019 C++ x64/x86 Spectre-mitigated libs (Latest)</code> where XXX will be the toolchain version. Next, search for <code>driver kit</code> then check the box next to <code>Windows Driver Kit</code>. On the bottom right, click Modify and wait for the process to complete.</p>
<p>Create a new project using one of the KMDF project templates available in Visual Studio. I chose Kernel Mode Driver (KMDF) for this walk-through. Wait for the project to load then switch the solution platform to x64 and try to build the project. If your environment is correct, the project should build without any errors or warnings. You may see some Intellisense errors about not being able to find some .tmh files. Don&rsquo;t worry about those for now.</p>
<h2 id="guest-setup">Guest Setup<a href="#guest-setup" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Once you have downloaded the VMWare Windows 10 development image from Microsoft, import the OVA into VMWare Workstation. If your host can spare the resources, consider increasing your guest RAM to 4GB and your processor core count to 2 for a better debugging experience.</p>
<p>VMWare will boot your Windows 10 image and log in to the desktop. The next step is to install the WDK Test Target package which can be found on your host system as  <code>C:\Program Files (x86)\Windows Kits\10\Remote\x64\WDK Test Target Setup x64-x64_en-us.msi</code>. Copy this file to your guest VM then run it.</p>
<p>Next, you will need to determine your networking information. Ensure that your VM is using a Host-Only network the grab your IP address. The default network should be in the <code>192.168.x.y</code> range. This information is needed to determine your host address which will be <code>192.168.x.1</code> where <code>x</code> is the second to last octet in your VM&rsquo;s IP address. Write this down for later.</p>
<p>Finally, you will need to know the VM&rsquo;s hostname. The default hostname as of writing this post is <code>WINDEV2106EVAL</code> but be sure to confirm before proceeding.</p>
<p><em>Make a VM snapshot before continuing!</em></p>
<h2 id="host-setup-part-2">Host Setup Part 2<a href="#host-setup-part-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Now that you have prepared the guest VM, we can continue configuring the debugger. Start by adding a new debugging target in Visual Studio. This can be done in several ways, one of which is to navigate to <code>Project Properties-&gt;Debugging</code> then select <code>Remote Computer Name</code>. Select <code>&lt;Configure&gt;</code> from the drop-down menu to launch the Configure Devices tool.</p>
<ol>
<li>Click Add New Device</li>
<li>Name your device. e.g. Win 10 2106 VM</li>
<li>Set the hostname. e.g. WINDEV2106EVAL</li>
<li>Select Provision device and choose debugger settings</li>
<li>Click Next</li>
<li>Ensure Network is selected for Connection Type</li>
<li>Change Host IP to <code>192.168.x.1</code> from the previous section</li>
<li>Click Next</li>
<li>Wait&hellip; some&hellip; time&hellip;</li>
<li>Finish</li>
</ol>
<p>The guest is now ready to be debugged. Consider taking a snapshot of the VM before moving on to the next section.</p>
<h2 id="deployment">Deployment<a href="#deployment" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>So far we have created a Visual Studio environment that supports driver development and we&rsquo;ve prepared a debuggable virtual machine hosted on VMWare Workstation. The last step is to deploy your driver and observe it populated in the target&rsquo;s device manager. From your project&rsquo;s property page, select <code>Driver-Install-&gt; Deployment</code> and pick your target VM from the drop-down menu. Select <code>Install/Reinstall and Verify</code> then click Apply.</p>
<p>Deploy the driver by right-clicking on the project and selecting Deploy. This process may take a couple of minutes to complete. If the deployment succeeds, you will see your device in the target&rsquo;s device manager.</p>
<p>In another post, I&rsquo;ll walk you through connecting with the debugger, loading symbols, and setting a breakpoint.</p>
<h3 id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If during deployment you get an error complaining about a missing VC142 library you can run this command from an elevated console as a solution. This must be run from an admin command prompt (not powershell).</p>
<pre tabindex="0"><code>cd /d %VCToolsRedistDir%\debug_nonredist 
MKLINK /J x86\Microsoft.VC141.DebugCRT x86\Microsoft.VC142.DebugCRT 
MKLINK /J x64\Microsoft.VC141.DebugCRT x64\Microsoft.VC142.DebugCRT
</code></pre>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://corytodd.us/tags/driver">Driver</a></span><span class="tag"><a href="https://corytodd.us/tags/visualstudio">VisualStudio</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>727 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-07-24 16:58 &#43;0000</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="https://github.com/corytodd/corytodd.us/commit/74e1211c0973e09aa6c99c3b1b8dc3bc15fcd80d" target="_blank" rel="noopener">74e1211</a> @ 2021-07-25</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://corytodd.us/posts/kmdf-debug-connect/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>KMDF Debugger Connection</span>
			</a>
			<a class="prev-post" href="https://corytodd.us/posts/vs-mystery-includes/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Visual Studio and The Mysterious Additional Includes</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2024 <a href="https://corytodd.us">Cory Todd</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://corytodd.us/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://corytodd.us/js/bundle.min.5a42c67b729ee2fa1059251688235399704707e04edb4e28c42c6f6dfa49d1d9.js" integrity="sha256-WkLGe3Ke4voQWSUWiCNTmXBHB+BO204oxCxvbfpJ0dk=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44428097-5', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
